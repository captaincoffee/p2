{% comment %}
Deriving useful variables from page.url
 - currentCollectionSlug : string current collection slug
 - currentCollection : jekyll:collection current collection
 - currentCollectionIndexUrl : string url for current collection

When on a category index page, we also create :
 - currentCategorySlug : string current category slug
 - currentCategoryIndexUrl : string url for current category
{% endcomment %}
{% include components/getVariablesFromPageUrl.html %}

<h1>{{ currentCollection.name }}</h1>

{% comment %}Sort collections articles by category
Returns an array : [ {"name"=>"chip-seals", "items"=>[#, #]},
                     {"name"=>"crack-joint-treatments", "items"=>[#]},
                     {"name"=>"microsurfacing-slurry", "items"=>[#]} ]
{% endcomment %}
{% assign byCategory = currentCollection.docs | group_by: 'category' %}

{% comment %}Prints categories in the same order as collection.categories{% endcomment %}
{% for category in currentCollection.categories %}

    {% comment %}
    Look for docs in current listed Category
    returns a hash : {"name"=>"chip-seals", "items"=>[#, #]}
    {% endcomment %}
    {% assign categoryDocs = byCategory | where: "name", category.slug | first %}

    {% if categoryDocs != nil %}
        {% capture categoryUrl %}{{ site.baseurl }}/{{ currentCollection.label }}/{{ category.slug }}/{% endcapture %}
        <h3> <a href="{{ categoryUrl }}">{{ category.name }}</a></h3>

        {% comment %}Sort category documents by type
        return an array  : [ {"name"=>"videos", "items"=>[#]},
                             {"name"=>"articles", "items"=>[#]} ]
        {% endcomment %}
        {% assign byType = categoryDocs.items | group_by: 'type' %}

        {% comment %}Sorting documents by type in site.types order{% endcomment %}
        {% for typeInfos in site.types %}
            {% assign currentType = typeInfos.slug %}
            {% comment %}Get documents for currentType{% endcomment %}
            {% assign currentTypeDocs = byType | where: "name", currentType | first %}
            {% if currentTypeDocs != nil %}
                <h4>{{ typeInfos.name }}</h4>
                {% for doc in currentTypeDocs.items %}
                  <p>
                    <a href="{{ site.baseurl }}{{ doc.url }}">{{ doc.title }}</a>
                  </p>
                {% endfor %}
            {% endif %}
        {% endfor %}
    {% endif %}
{% endfor %}
